<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Выбор даты</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff; /* fallback */
            color: #000000; /* fallback */
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 400px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            color: #000000; /* fallback */
        }

        .calendar {
            background: #f0f0f0; /* fallback для secondary-bg */
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .month-year {
            font-size: 18px;
            font-weight: 600;
            color: #000000; /* fallback */
        }

        .nav-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000000; /* fallback */
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #e0e0e0; /* fallback для hint */
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .weekday {
            text-align: center;
            font-size: 14px;
            color: #888888; /* fallback для hint */
            font-weight: 500;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.2s, color 0.2s;
            color: #000000; /* fallback */
        }

        .day.other-month {
            color: #888888; /* fallback */
            pointer-events: none;
        }

        .day.today {
            background: #e0e0e0; /* fallback */
        }

        .day.selected {
            background: #007aff; /* fallback для button */
            color: #ffffff; /* fallback для button-text */
        }

        .day:hover:not(.other-month):not(.selected) {
            background: #e0e0e0; /* fallback */
        }

        #confirmBtn {
            width: 100%;
            padding: 15px;
            background: #007aff; /* fallback */
            color: #ffffff; /* fallback */
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-top: 10px;
        }

        #confirmBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #selectedDate {
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
            color: #000000; /* fallback */
        }

        .holiday {
            color: #007aff; /* fallback */
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Выберите дату</h1>
        <div class="calendar">
            <div class="calendar-header">
                <button class="nav-btn" id="prevMonth">&lt;</button>
                <span class="month-year" id="monthYear"></span>
                <button class="nav-btn" id="nextMonth">&gt;</button>
            </div>
            <div class="weekdays">
                <div class="weekday">Пн</div>
                <div class="weekday">Вт</div>
                <div class="weekday">Ср</div>
                <div class="weekday">Чт</div>
                <div class="weekday">Пт</div>
                <div class="weekday">Сб</div>
                <div class="weekday">Вс</div>
            </div>
            <div class="days-grid" id="daysGrid"></div>
        </div>
        <div id="selectedDate">Выбрано: не выбрано</div>
        <button id="confirmBtn" disabled>Подтвердить</button>
    </div>

    <script>
    const tg = window.Telegram.WebApp;
    console.log("Date picker script started");
    tg.ready();
    console.log("Telegram WebApp ready and expanded");
    tg.expand();

    // Применяем тему Telegram (твой код без изменений)
    if (tg.themeParams) {
        console.log("Applying Telegram theme:", tg.themeParams);
        const tp = tg.themeParams;
        document.body.style.backgroundColor = tp.bg_color || '#ffffff';
        document.body.style.color = tp.text_color || '#000000';
        document.querySelector('h1').style.color = tp.text_color || '#000000';
        document.querySelector('.month-year').style.color = tp.text_color || '#000000';
        document.querySelectorAll('.nav-btn').forEach(btn => btn.style.color = tp.text_color || '#000000');
        document.querySelectorAll('.day').forEach(day => day.style.color = tp.text_color || '#000000');
        document.querySelector('#selectedDate').style.color = tp.text_color || '#000000';
        const secondaryBg = tp.secondary_bg_color || '#f0f0f0';
        document.querySelector('.calendar').style.backgroundColor = secondaryBg;
        const hint = tp.hint_color || '#888888';
        document.querySelectorAll('.weekday').forEach(w => w.style.color = hint);
        document.querySelectorAll('.day.other-month').forEach(d => d.style.color = hint);
        document.querySelectorAll('.day.today').forEach(d => d.style.backgroundColor = hint + '40');
        document.querySelectorAll('.day:hover:not(.other-month):not(.selected)').forEach(d => d.style.backgroundColor = hint + '40');
        const buttonBg = tp.button_color || '#007aff';
        const buttonText = tp.button_text_color || '#ffffff';
        document.querySelector('#confirmBtn').style.backgroundColor = buttonBg;
        document.querySelector('#confirmBtn').style.color = buttonText;
        document.querySelectorAll('.day.selected').forEach(d => {
            d.style.backgroundColor = buttonBg;
            d.style.color = buttonText;
        });
        document.querySelectorAll('.holiday').forEach(h => h.style.color = buttonBg);
    } else {
        console.log("Telegram themeParams not available");
    }

    const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
    let currentDate = new Date();
    let selectedDate = new Date(); // текущая дата по умолчанию
    selectedDate.setHours(0, 0, 0, 0);
    console.log("Initial selected date:", formatDate(selectedDate));

    const monthYear = document.getElementById('monthYear');
    const daysGrid = document.getElementById('daysGrid');
    const selectedDateEl = document.getElementById('selectedDate');
    const confirmBtn = document.getElementById('confirmBtn');
    const prevMonth = document.getElementById('prevMonth');
    const nextMonth = document.getElementById('nextMonth');

    const holidays = {
        '1-1': 'Новый год',
        '1-2': 'Новогодние каникулы',
        '1-3': 'Новогодние каникулы',
        '1-4': 'Новогодние каникулы',
        '1-5': 'Новогодние каникулы',
        '1-6': 'Новогодние каникулы',
        '1-7': 'Рождество Христово',
        '1-8': 'Новогодние каникулы',
        '2-23': 'День защитника Отечества',
        '3-8': 'Международный женский день',
        '5-1': 'Праздник Весны и Труда',
        '5-9': 'День Победы',
        '6-12': 'День России',
        '11-4': 'День народного единства'
    };

    function renderCalendar() {
        console.log("Rendering calendar for:", currentDate.toLocaleDateString('ru-RU'));
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        monthYear.textContent = `${monthNames[month]} ${year}`;
        daysGrid.innerHTML = '';

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let startDay = firstDay === 0 ? 6 : firstDay - 1;

        // Предыдущий месяц
        for (let i = startDay - 1; i >= 0; i--) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('day', 'other-month');
            dayEl.textContent = daysInPrevMonth - i;
            daysGrid.appendChild(dayEl);
        }

        // Текущий месяц
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('day');
            dayEl.textContent = day;

            const thisDate = new Date(year, month, day);
            thisDate.setHours(0, 0, 0, 0);

            const holidayKey = `${month + 1}-${day}`;
            if (holidays[holidayKey]) {
                dayEl.classList.add('holiday');
                dayEl.title = holidays[holidayKey];
            }

            if (thisDate.getTime() === today.getTime()) {
                dayEl.classList.add('today');
            }

            if (selectedDate && thisDate.getTime() === selectedDate.getTime()) {
                dayEl.classList.add('selected');
            }

            if (thisDate < today) {
                dayEl.classList.add('disabled');
            } else {
                dayEl.addEventListener('click', () => {
                    selectedDate = thisDate;
                    console.log("Date selected by click:", formatDate(selectedDate));
                    updateSelected();
                    renderCalendar();
                });
            }

            daysGrid.appendChild(dayEl);
        }

        // Следующий месяц (заполнение)
        const remainingDays = 42 - (startDay + daysInMonth);
        for (let day = 1; day <= remainingDays; day++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('day', 'other-month');
            dayEl.textContent = day;
            daysGrid.appendChild(dayEl);
        }

        updateSelected();
    }

    function updateSelected() {
        selectedDateEl.textContent = `Выбрано: ${formatDateDisplay(selectedDate)}`;
        confirmBtn.disabled = false;
        console.log("Updated selected display:", formatDateDisplay(selectedDate));
    }

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDateDisplay(date) {
        const day = date.getDate();
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        return `${day} ${month} ${year}`;
    }

    prevMonth.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        console.log("Previous month clicked");
        renderCalendar();
    });

    nextMonth.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        console.log("Next month clicked");
        renderCalendar();
    });

    confirmBtn.addEventListener('click', () => {
        const dateStr = formatDate(selectedDate);
        console.log("Confirm button clicked. Sending data to bot:", dateStr);
        tg.sendData(dateStr);
        tg.close();
        console.log("WebApp closed after sending data");
    });

    renderCalendar();
    console.log("Calendar rendered initially");
</script>
</body>
</html>
